<ion-content>
  @if (loading) {
    <div class="loading-container">
      <app-loading />
    </div>
  }

  @if (!loading) {
    @if (routeData) {
      <ion-card>
        <ion-item class="title">
          <!--
            Icono del encabezado (UI):
            - Se decide en TS con headerIconSrc (prioridad + riesgo social => sin icono).
            - NO depende de isEmergency para no mezclar UI con la lógica del documento/FAB.
          -->
          @if (headerIconSrc) {
            <img
              [src]="headerIconSrc"
              alt="Tipo de entrega"
              style="height: 22px; width: 22px; margin-right: 8px;"
            />
          }

          Exp: {{ routeData.expediente }}
        </ion-item>

        <!-- Notas generales del expediente -->
        @if (routeData.notas?.length > 0) {
          <ion-item class="notas">
            <p>Notas:</p>
            <div style="margin-left: 8px;">
              <div>
                @for (nota of routeData.notas; track nota) {
                  <div>
                    <p>{{ nota }}</p>
                  </div>
                }
              </div>
            </div>
          </ion-item>
        }

        <!-- Lista de comensales -->
        @if (routeData.comensales?.length > 0) {
          <ion-list>
            <swiper-container>
              @for (persona of routeData.comensales; track $index) {
                <swiper-slide>
                  <ion-item lines="none">
                    <ion-label>
                      <dl class="comensal-list">
                        <dt>Cliente</dt>
                        <!--
                          Refuerzo de visualización (solo UI):
                          - Envuelvo el texto en ion-text con ion-text-wrap para facilitar saltos de línea.
                          - No cambia datos ni lógica, solo ayuda a que nombres largos se vean completos.
                        -->
                        <dd>
                          <ion-text class="ion-text-wrap">
                            {{ persona.nombre }} {{ persona.apellidos }}
                          </ion-text>
                        </dd>
                      </dl>

                      <div class="comensal-grid">
                        <dl>
                          <dt>Dieta</dt>
                          <dd>{{ persona.dieta }}</dd>

                          <dt>Cenas</dt>
                          <dd>{{ persona.cenas }}</dd>

                          <dt>Comidas</dt>
                          <dd>{{ persona.comidas }}</dd>

                          <dt>Pan Molde</dt>
                          @if (persona.panMolde === '-') {
                            <dd>{{ persona.panMolde }}</dd>
                          } @else {
                            <dd>{{ persona.panMolde }} ({{ persona.panMoldeUds }} uds.)</dd>
                          }

                          <dt>Pan Individual</dt>
                          @if (persona.panIndividual === '-') {
                            <dd>{{ persona.panIndividual }}</dd>
                          } @else {
                            <dd>{{ persona.panIndividual }} ({{ persona.panIndividualUds }} uds.)</dd>
                          }

                          <dt>Leche</dt>
                          @if (persona.leche === '-') {
                            <dd>{{ persona.leche }}</dd>
                          } @else {
                            <dd>{{ persona.leche }} ({{ persona.lecheUds }} uds.)</dd>
                          }

                          <dt>Yogures</dt>
                          @if (persona.yogures === '-') {
                            <dd>{{ persona.yogures }}</dd>
                          } @else {
                            <dd>{{ persona.yogures }} ({{ persona.yoguresUds }} uds.)</dd>
                          }

                          <dt>Bolsa saludable</dt>
                          @if (persona.bolsaSaludable === '-') {
                            <dd>{{ persona.bolsaSaludable }}</dd>
                          } @else {
                            <dd>{{ persona.bolsaSaludable }} ({{ persona.bolsaSaludableUds }} uds.)</dd>
                          }

                          <dt>Zumo</dt>
                          @if (persona.zumo === '-') {
                            <dd>{{ persona.zumo }}</dd>
                          } @else {
                            <dd>{{ persona.zumo }} ({{ persona.zumoUds }} uds.)</dd>
                          }

                          <dt>Condimentación</dt>
                          <dd>{{ persona.condimentacion }}</dd>
                        </dl>

                        <dl>
                          <dt>Riesgo social</dt>
                          <dd>{{ persona.riesgoSocial }}</dd>

                          <dt>Presentación</dt>
                          <dd>{{ persona.formaPresentacion }}</dd>

                          <dt>No nevera</dt>
                          <dd>{{ persona.noNevera }}</dd>

                          <dt>No imán</dt>
                          <dd>{{ persona.noIman }}</dd>

                          <dt>Emergencia</dt>
                          <dd>{{ persona.comidaEmergencia }}</dd>

                          <dt>Cumpleaño c/azúcar</dt>
                          <dd>{{ persona.cumpleanosConAzucar }}</dd>

                          <dt>Cumpleaño s/azúcar</dt>
                          <dd>{{ persona.cumpleanosSinAzucar }}</dd>

                          <dt>Notas dieta</dt>
                          @if (persona.notasDieta?.length > 0) {
                            <dd>{{ persona.notasDieta }}</dd>
                          } @else {
                            <dd>-</dd>
                          }

                          <dt>Notas reparto</dt>
                          @if (persona.notasReparto?.length > 0) {
                            <dd>{{ persona.notasReparto }}</dd>
                          } @else {
                            <dd>-</dd>
                          }
                        </dl>
                      </div>
                    </ion-label>
                  </ion-item>
                </swiper-slide>
              }
            </swiper-container>
          </ion-list>
        }
      </ion-card>
    } @else {
      <div class="no-data">
        <p>No hay datos disponibles para este expediente.</p>
      </div>
    }

    @if (!isDelivered) {
      <ion-fab vertical="bottom" horizontal="end" slot="fixed">
        <ion-fab-button (click)="openModal()">
          <ion-icon name="menu-outline"></ion-icon>
        </ion-fab-button>

        <!--
           Este bloque se mantiene igual a propósito:
          isEmergency controla el flujo del documento/FAB (producción).
        -->
        @if (this.isEmergency) {
          @if (this.documentDevlivered) {
            <ion-fab-button disabled>
              <ion-icon name="checkmark-outline"></ion-icon>
            </ion-fab-button>
          } @else {
            <ion-fab-button (click)="openModalFile()">
              <ion-icon name="document-outline"></ion-icon>
            </ion-fab-button>
          }
        }

        <ion-fab-button (click)="openMap()">
          <ion-icon name="map-outline"></ion-icon>
        </ion-fab-button>

        @if (qrSupported) {
          <ion-fab-button (click)="onClickQr()" title="Entrega por QR" aria-label="Entrega por QR">
            <ion-icon name="qr-code-outline"></ion-icon>
          </ion-fab-button>
        }

        @if (nfcSupported) {
          <ion-fab-button
            class="fab-nfc"
            (click)="onClickNfc()"
            [disabled]="nfcBusy"
            title="Entrega por NFC"
            aria-label="Entrega por NFC"
          >
            <ion-icon name="scan-outline"></ion-icon>
          </ion-fab-button>
        }
      </ion-fab>
    } @else {
      <ion-fab slot="fixed" vertical="bottom" horizontal="end">
        <ion-fab-button disabled>
          <ion-icon name="checkmark-outline"></ion-icon>
        </ion-fab-button>
      </ion-fab>
    }
  }
</ion-content>
